#!/bin/bash

# Pre-commit hook to run tests before committing
# This ensures code quality and prevents broken commits

echo "ğŸ§ª Running tests before commit..."
echo ""

# Run linter
echo ""
echo "ğŸ” Running linter..."
npm run lint
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Linting failed. Fix the issues above before committing."
  exit 1
fi

# Compile TypeScript
echo ""
echo "ğŸ”¨ Compiling TypeScript..."
npm run compile
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ TypeScript compilation failed. Fix the errors above before committing."
  exit 1
fi

# Build the extension bundle used by the demo (dist/)
echo ""
echo "ğŸ“¦ Building extension bundle (dist)..."
npm run build:dist
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Build failed. Fix the errors above before committing."
  exit 1
fi

# Type-check Playwright demo code (not part of extension build)
echo ""
echo "ğŸ­ Type-checking Playwright demo..."
npm run typecheck:playwright
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Playwright demo typecheck failed. Fix the errors above before committing."
  exit 1
fi

# NOTE: Updating the README demo video is intentionally NOT part of the pre-commit hook.
# The video pipeline can produce artifact churn (e.g. encoding/duration differences) and
# should be run intentionally when you want to refresh the README.
#
# Run manually when needed:
#   npm run demo:pw:update-readme

# Run tests
echo ""
echo "ğŸ§ª Running tests..."
npm test
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Tests failed. Fix the failing tests before committing."
  echo ""
  echo "ğŸ’¡ Tip: If tests are timing out or hanging, you may need to:"
  echo "   - Close any running VS Code instances testing the extension"
  echo "   - Kill any hanging test processes"
  echo "   - Run tests again"
  exit 1
fi

echo ""
echo "âœ… All checks passed! Proceeding with commit."
echo ""
