#!/bin/bash

# Pre-commit hook to run tests before committing
# This ensures code quality and prevents broken commits

echo "üß™ Running tests before commit..."
echo ""

# Run linter
echo ""
echo "üîç Running linter..."
npm run lint
if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Linting failed. Fix the issues above before committing."
  exit 1
fi

# Compile TypeScript
echo ""
echo "üî® Compiling TypeScript..."
npm run compile
if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå TypeScript compilation failed. Fix the errors above before committing."
  exit 1
fi

# Build the extension bundle used by the demo (dist/)
echo ""
echo "üì¶ Building extension bundle (dist)..."
npm run build:dist
if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Build failed. Fix the errors above before committing."
  exit 1
fi

# Run the Playwright demo flow that generates (and injects) the demo video.
# NOTE: This may modify tracked files (e.g. README.md / docs/pw-videos/demo.mp4).
echo ""
echo "üé• Generating Playwright demo video..."

# IMPORTANT: The demo drives Copilot Chat. If we run against a clean, downloaded VS Code,
# Copilot will not be signed in and the demo will fail (and waste time downloading).
# Require the user to point Playwright at a system-installed VS Code (signed in),
# or explicitly clone a signed-in user data dir.
if [ -z "${PW_VSCODE_EXECUTABLE_PATH:-}" ] && [ -z "${PW_VSCODE_CLONE_USER_DATA_FROM:-}" ]; then
  echo ""
  echo "‚ùå Demo video generation requires a signed-in VS Code profile."
  echo "   Set one of the following environment variables and re-run commit:"
  echo ""
  echo "   - PW_VSCODE_EXECUTABLE_PATH=/Applications/Visual\ Studio\ Code.app"
  echo "     (or VS Code Insiders.app)"
  echo ""
  echo "   - PW_VSCODE_CLONE_USER_DATA_FROM=default"
  echo "     (or a concrete path like '$HOME/Library/Application Support/Code')"
  echo ""
  echo "   Optionally also set PW_VSCODE_PROFILE if you use a non-default profile."
  exit 1
fi

npm run demo:pw:update-readme
if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Demo generation failed. Fix the errors above before committing."
  exit 1
fi

# If the demo updated tracked files, require staging them so the commit actually includes the new video/README.
if ! git diff --quiet; then
  echo ""
  echo "üìù Demo generation produced changes that are not staged."
  echo "   Please review and stage the updated files, then re-run your commit."
  echo ""
  git --no-pager diff --name-only
  exit 1
fi

# Type-check Playwright demo code (not part of extension build)
echo ""
echo "üé≠ Type-checking Playwright demo..."
npm run typecheck:playwright
if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Playwright demo typecheck failed. Fix the errors above before committing."
  exit 1
fi

# Run tests
echo ""
echo "üß™ Running tests..."
npm test
if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Tests failed. Fix the failing tests before committing."
  echo ""
  echo "üí° Tip: If tests are timing out or hanging, you may need to:"
  echo "   - Close any running VS Code instances testing the extension"
  echo "   - Kill any hanging test processes"
  echo "   - Run tests again"
  exit 1
fi

echo ""
echo "‚úÖ All checks passed! Proceeding with commit."
echo ""
