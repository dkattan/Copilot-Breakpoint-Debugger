name: Artifact runtime env smoke

on:
  workflow_dispatch: {}
  push:
    branches:
      - main
    paths:
      - .github/workflows/artifact-runtime-smoke.yml
      - .github/actions/**
      - scripts/upload-single-file-artifact.cjs
      - scripts/download-single-file-artifact.cjs
      - test-assets/smoke.mp4

jobs:
  smoke-host:
    name: Smoke (host runner)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print runtime env (partial)
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${ACTIONS_RUNTIME_TOKEN:-}" ]; then
            token="$ACTIONS_RUNTIME_TOKEN"
            echo "ACTIONS_RUNTIME_TOKEN=${token:0:6}…${token: -6} (len=${#token})"
          else
            echo "ACTIONS_RUNTIME_TOKEN=<unset>"
          fi
          echo "ACTIONS_RUNTIME_URL=${ACTIONS_RUNTIME_URL:-<unset>}"
          echo "ACTIONS_RESULTS_URL=${ACTIONS_RESULTS_URL:-<unset>}"

      - name: Create tiny file
        shell: bash
        run: |
          set -euo pipefail
          ls -la test-assets/smoke.mp4

      - name: Compute SHA-256 (source)
        id: sha
        shell: bash
        run: |
          set -euo pipefail
          sha=$(sha256sum test-assets/smoke.mp4 | awk '{print $1}')
          echo "sha256=$sha" >> "$GITHUB_OUTPUT"
          echo "SHA256(source)=$sha"

      - name: Upload tiny file (official upload-artifact)
        uses: actions/upload-artifact@v4
        with:
          name: smoke-official
          path: test-assets/smoke.mp4
          if-no-files-found: error

      - name: Init toolkit submodule
        run: git submodule update --init --depth 1 external/toolkit

      - name: Build dkattan/toolkit @actions/artifact
        shell: bash
        run: |
          set -euo pipefail
          cd external/toolkit
          npm install
          npm run bootstrap
          npm run build
          test -f packages/artifact/lib/artifact.js

      - name: Upload tiny file (toolkit zip:false)
        uses: ./.github/actions/upload-single-file-artifact
        with:
          name: smoke-toolkit
          file: test-assets/smoke.mp4
          retention-days: '1'
          debug-env: 'true'

      - name: Download tiny file (toolkit) + verify SHA-256
        uses: ./.github/actions/download-single-file-artifact
        with:
          name: smoke-toolkit
          download-dir: downloaded
          expected-sha256: ${{ steps.sha.outputs.sha256 }}
          debug-env: 'true'

  smoke-container:
    name: Smoke (container job)
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.58.0-jammy

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print runtime env (partial)
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${ACTIONS_RUNTIME_TOKEN:-}" ]; then
            token="$ACTIONS_RUNTIME_TOKEN"
            echo "ACTIONS_RUNTIME_TOKEN=${token:0:6}…${token: -6} (len=${#token})"
          else
            echo "ACTIONS_RUNTIME_TOKEN=<unset>"
          fi
          echo "ACTIONS_RUNTIME_URL=${ACTIONS_RUNTIME_URL:-<unset>}"
          echo "ACTIONS_RESULTS_URL=${ACTIONS_RESULTS_URL:-<unset>}"

      - name: Create tiny file
        shell: bash
        run: |
          set -euo pipefail
          ls -la test-assets/smoke.mp4

      - name: Compute SHA-256 (source)
        id: sha
        shell: bash
        run: |
          set -euo pipefail
          sha=$(sha256sum test-assets/smoke.mp4 | awk '{print $1}')
          echo "sha256=$sha" >> "$GITHUB_OUTPUT"
          echo "SHA256(source)=$sha"

      - name: Upload tiny file (official upload-artifact)
        uses: actions/upload-artifact@v4
        with:
          name: smoke-official-container
          path: test-assets/smoke.mp4
          if-no-files-found: error

      - name: Init toolkit submodule
        run: git submodule update --init --depth 1 external/toolkit

      - name: Build dkattan/toolkit @actions/artifact
        shell: bash
        run: |
          set -euo pipefail
          cd external/toolkit
          npm install
          npm run bootstrap
          npm run build
          test -f packages/artifact/lib/artifact.js

      - name: Upload tiny file (toolkit zip:false)
        uses: ./.github/actions/upload-single-file-artifact
        with:
          name: smoke-toolkit-container
          file: test-assets/smoke.mp4
          retention-days: '1'
          debug-env: 'true'

      - name: Download tiny file (toolkit) + verify SHA-256
        uses: ./.github/actions/download-single-file-artifact
        with:
          name: smoke-toolkit-container
          download-dir: downloaded
          expected-sha256: ${{ steps.sha.outputs.sha256 }}
          debug-env: 'true'
